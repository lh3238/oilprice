<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Bar Chart with D3.js</title>
    <style>
        .bar {
            fill: steelblue;
        }
        .bar:hover {
            fill: orange;
        }
        .overlay-bar {
            fill: lightgreen;
        }
        #chart-container {
            display: flex;
            align-items: flex-start;
        }
        #radio-wrapper {
            margin-left: 20px;

            display: flex;
            flex-direction: column;
        }
        svg {
            display: block;
            max-width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <div id="chart-container">
        <div id="chart" style="flex-grow: 1;"> </div>
        <div id="radio-wrapper"></div>
    </div>
    <p>We used a stacked bar chart to compare the relationship
        between regional and organizational oil export volumes
        and the total world oil export volume. Compared to using
        simple bar or line charts, this approach not only informs
        us about the historical oil export volumes of regions
        and organizations but also shows the proportion of these
        exports in the world's total oil exports. Understanding
        both aspects is crucial for analyzing oil prices, as the
        amount of oil exported determines the influence of a region
        or organization on global oil prices. However, knowing the
        export volume alone is insufficient. For instance, while
        OPEC's oil exports in 2022 increased compared to 1980, its
        share in the global oil export market has declined. By
        comparing the export volumes of other regions, we found
        that OECD's oil exports have been increasing annually.
        This can be attributed to two main reasons. First, since
        2010, the maturation of shale oil extraction technology
        in the United States has turned it into a major oil exporter
        , thereby encroaching on OPEC's market share. Second,
        for political and security reasons, the OECD, led by the
        United States, intentionally reduced its reliance on oil
        imports from OPEC countries and gradually shifted to
        purchasing oil from other regions. Interactive graphics
        created with D3 make it easier and clearer for us to
        identify these trends, thereby assisting us in conducting
        a more objective and accurate analysis of other aspects.</p>
    <script src="https://d3js.org/d3.v7.js"></script>
    <script>
        // Set chart dimensions and margins
        const margin = { top: 30, right: 10, bottom: 50, left: 80 },
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        // Create SVG element
        const svg = d3.select("#chart").append("svg")
            .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Define scales and axes
        const x = d3.scaleBand().range([0, width]).padding(0.1);
        const y = d3.scaleLinear().range([height, 0]);

        let regionsData;
        let years;

        // Load CSV data
        d3.csv("ASB2023_all/T52_pruned.csv").then(data => {
            years = data.columns.slice(1);
            regionsData = data.reduce((accumulator, d) => {
                accumulator[d.Region] = years.map(year => ({
                    year: year,
                    value: +d[year].replace(/,/g, '') // Remove commas and convert to number
                }));
                return accumulator;
            }, {});

            // Set scale domains
            x.domain(regionsData['Total_world'].map(d => d.year));
            y.domain([0, d3.max(regionsData['Total_world'], d => d.value)]);

            // Add x and y axes to the chart
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text") // Select all x-axis labels
                .style("text-anchor", "end") // Set text anchor (alignment) to the end
                .attr("dx", "-.8em") // Adjust text position along x-axis
                .attr("dy", ".15em") // Adjust text position along y-axis
                .attr("transform", "rotate(-30)"); // Rotate labels

            svg.append("g")
                .attr("class", "y axis")
                .call(d3.axisLeft(y));

            // Draw the 'Total_world' bar chart
            drawBarChart(regionsData['Total_world'], 'bar');

            // Add radio buttons for selecting regions, excluding 'Total_world' and empty string
            createRadioButtons(Object.keys(regionsData).filter(region => region !== 'Total_world' && region !== ''));

        });

        // Add a title to the chart
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .style("text-decoration", "underline")
            .text("Crude Oil Export Trends");

        // Add x-axis label
        svg.append("text")
            .attr("transform", `translate(${width / 2}, ${height + margin.top + 20})`)
            .style("text-anchor", "middle")
            .text("Years");

        // Add y-axis label
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("Crude Oil Export (1,000 b/d)");

        // Function to draw the bar chart
        function drawBarChart(data, className) {
            svg.selectAll(`.${className}`)
                .data(data)
                .join(
                    enter => enter.append("rect")
                        .attr("class", className)
                        .attr("x", d => x(d.year))
                        .attr("width", x.bandwidth())
                        .attr("y", height) // Start from the bottom
                        .attr("height", 0) // Initial height is 0
                        .call(enter => enter.transition()
                            .duration(750)
                            .attr("y", d => y(d.value))
                            .attr("height", d => height - y(d.value))),
                    update => update.call(update => update.transition()
                        .duration(750)
                        .attr("x", d => x(d.year))
                        .attr("width", x.bandwidth())
                        .attr("y", d => y(d.value))
                        .attr("height", d => height - y(d.value))),
                    exit => exit.call(exit => exit.transition()
                        .duration(750)
                        .attr("y", height)
                        .attr("height", 0)
                        .remove())
                );
        }

        // Function to create radio buttons
        function createRadioButtons(regions) {
            const radioWrapper = d3.select("#radio-wrapper");
            regions.forEach(region => {
                const label = radioWrapper.append("label")
                    .style("display", "block")
                    .text(region);

                label.append("input")
                    .attr("type", "radio")
                    .attr("name", "region")
                    .attr("value", region)
                    .on("change", function () {
                        if (this.checked) {
                            svg.selectAll(".overlay-bar").remove();
                            drawBarChart(regionsData[this.value], 'overlay-bar');
                        }
                    });
            });
        }
    </script>
</body>

</html>
